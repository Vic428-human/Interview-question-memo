

```
import rootAxios from './rootAxios';

// ====== 下單相關類型定義 ======
export type OrderItem = {
  productId: string;
  productName: string;
  price: number;
  originalPrice: number;
  quantity: number;
  variation?: {
    size?: string;
    color?: string;
    style?: string;
  };
  shopId: string;
  shopName: string;
  weight: number; // 用於計算運費
  isDigital: boolean; // 數位商品不需運送
};

export type ShippingAddress = {
  recipientName: string;
  phone: string;
  email?: string;
  address: string;
  city: string;
  district: string;
  postalCode: string;
  isDefault: boolean;
  addressType: 'home' | 'office' | 'other';
  specialInstructions?: string;
};

export type PaymentInfo = {
  method: 'credit_card' | 'bank_transfer' | 'cod' | 'shopee_pay' | 'installment';
  cardToken?: string; // 信用卡 token
  installmentPlan?: 3 | 6 | 12 | 24; // 分期期數
  bankCode?: string; // 銀行代碼
};

export type ShippingOption = {
  method: 'standard' | 'express' | 'pickup' | 'convenience_store';
  providerId: string; // 物流商 ID
  providerName: string; // 物流商名稱
  fee: number;
  estimatedDays: number;
  pickupStoreId?: string; // 便利商店取貨店鋪 ID
  pickupStoreName?: string;
  pickupStoreAddress?: string;
};

export type CouponInfo = {
  code: string;
  type: 'percentage' | 'fixed_amount' | 'shipping_free';
  value: number;
  minOrderAmount?: number;
  maxDiscountAmount?: number;
  applicableShops?: string[]; // 適用店家
  applicableCategories?: string[]; // 適用分類
};

export type PlaceOrderData = {
  items: OrderItem[];
  shippingAddress: ShippingAddress;
  paymentInfo: PaymentInfo;
  shippingOption: ShippingOption;
  coupons?: CouponInfo[]; // 可使用多張優惠券
  orderNote?: string;
  giftMessage?: string;
  isGift: boolean;
  scheduledDelivery?: {
    date: string;
    timeSlot: 'morning' | 'afternoon' | 'evening';
  };
  loyaltyPointsToUse?: number; // 使用點數折抵
  referralCode?: string; // 推薦碼
  marketingConsent: boolean; // 行銷同意
};

// ====== API 回應類型 ======
export type PlaceOrderResponse = {
  data: {
    code: number;
    detailCode: string;
    message: string;
    result?: {
      orderId: string;
      orderNumber: string;
      totalAmount: number;
      finalAmount: number;
      discountAmount: number;
      shippingFee: number;
      taxAmount: number;
      pointsEarned: number;
      estimatedDeliveryDate: string;
      paymentDetails: {
        method: string;
        status: 'pending' | 'processing' | 'completed' | 'failed';
        transactionId?: string;
        paymentUrl?: string; // 第三方支付跳轉網址
        qrCode?: string; // 行動支付 QR Code
      };
      shippingDetails: {
        trackingNumber?: string;
        provider: string;
        estimatedDelivery: string;
        pickupInfo?: {
          storeId: string;
          storeName: string;
          address: string;
          pickupCode: string;
        };
      };
      invoiceInfo: {
        type: 'personal' | 'company';
        number?: string;
        companyName?: string;
        taxId?: string;
      };
      appliedPromotions: {
        couponCode?: string;
        discountAmount: number;
        pointsUsed?: number;
        pointsValue?: number;
      }[];
    };
    metadata?: {
      processingTime: number;
      ab_test_id?: string;
      recommendation_id?: string;
      fraud_score?: number;
    };
  };
};

// ====== 複雜的下單 API ======
export const apiPlaceOrder = async (order: PlaceOrderData): Promise<PlaceOrderResponse> => {
  // 在發送請求前進行複雜的資料驗證和處理
  const processedOrder = {
    ...order,
    // 計算總重量
    totalWeight: order.items.reduce((sum, item) => sum + (item.weight * item.quantity), 0),
    // 按店家分組商品
    itemsByShop: order.items.reduce((groups, item) => {
      const shopId = item.shopId;
      if (!groups[shopId]) {
        groups[shopId] = [];
      }
      groups[shopId].push(item);
      return groups;
    }, {} as Record<string, OrderItem[]>),
    // 計算預估稅額
    estimatedTax: order.items.reduce((sum, item) => 
      sum + (item.price * item.quantity * 0.05), 0), // 假設 5% 稅率
    // 客戶端時間戳
    clientTimestamp: new Date().toISOString(),
    // 設備資訊
    deviceInfo: {
      userAgent: typeof navigator !== 'undefined' ? navigator.userAgent : '',
      platform: typeof navigator !== 'undefined' ? navigator.platform : '',
      language: typeof navigator !== 'undefined' ? navigator.language : '',
    }
  };

  const res = await rootAxios.post('orders/place', processedOrder, {
    headers: {
      'Content-Type': 'application/json',
      'X-Request-ID': `order_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
      'X-Client-Version': '1.0.0',
    },
    timeout: 30000, // 30秒超時
  });
  
  return res.data;
};
```
